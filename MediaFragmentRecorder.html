<!DOCTYPE html>
<html>

<head>
</head>

<body>
  <h1>click</h1>
  <script>
    const blobs = [];
    const urls = Promise.all([{
      src: "https://upload.wikimedia.org/wikipedia/commons/a/a4/Xacti-AC8EX-Sample_video-001.ogv",
      from: 0,
      to: 4
    }, {
      src: "https://mirrors.creativecommons.org/movingimages/webm/ScienceCommonsJesseDylan_240p.webm#t=10,20",
      from: 10,
      to: 20
    }, {
      from: 55,
      to: 60,
      src: "https://nickdesaulniers.github.io/netfix/demo/frag_bunny.mp4"
    }, {
      from: 0,
      to: 5,
      src: "https://raw.githubusercontent.com/w3c/web-platform-tests/master/media-source/mp4/test.mp4"
    }, {
      from: 0,
      to: 5,
      src: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4"
    }, {
      from: 0,
      to: 5,
      src: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4"
    }, {
      from: 0,
      to: 6,
      src: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4#t=0,6"
    }].map(async({
      from,
      to,
      src
    }) => {
      try {
        const request = await fetch(src);
        const blob = await request.blob();
        const blobURL = URL.createObjectURL(blob);
        blobs.push(blobURL);
        const url = new URL(src);
        console.log(url.hash);
        return blobURL + (url.hash || `#t=${from},${to}`);
      } catch (e) {
        throw e;;
      }
    }));

    onclick = async _ => {
      const playlist = await urls;
      console.log(playlist);
      const video = document.createElement("video");
      const ac = new AudioContext();
      const mes = new MediaElementAudioSourceNode(ac, {mediaElement:video});
      const msd = new MediaStreamAudioDestinationNode(ac);
      const audioStream = msd.stream;
      mes.connect(ac.destination);
      mes.connect(msd);
      const [audioTrack] = audioStream.getAudioTracks();
      let recorder, stream, videoTrack;

      async function recordPictureInPictureWindow(urls) {
        let result;
        for (const blobURL of playlist) {
          await new Promise(async resolve => {
            if (!recorder) {
              video.addEventListener("loadedmetadata", async _ => {
                await video.requestPictureInPicture();
              }, {
                once: true
              });
            };
            video.addEventListener("play", _ => {
              if (recorder && recorder.state === "paused") {
                recorder.resume();
              }
            }, {
              once: true
            });
            video.addEventListener("canplay", async e => {
              try {
                if (!stream) {
                  // Application => Picture in picture
                  stream = await navigator.mediaDevices.getDisplayMedia({
                    video: true
                  });
                  video.width = screen.width/2;
                  ([videoTrack] = stream.getVideoTracks());
                  await videoTrack.applyConstraints({resizeMode:"crop-and-scale"});
                  console.log(videoTrack.getSettings());
                  stream.addTrack(audioTrack);
                  recorder = new MediaRecorder(stream);
                  recorder.ondataavailable = e => result = URL.createObjectURL(e.data);
                  recorder.start();
                }
                await video.play()
              } catch (e) {
                console.error(e);
              }
            });
            video.addEventListener("pause", _ => {
              recorder.pause();
              resolve();
            }, {
              once: true
            });

            video.src = blobURL;
          });
        }
        recorder.stop();
        videoTrack.stop();
        audioTrack.stop();
        await document.exitPictureInPicture();
        return result;
      }
      recordPictureInPictureWindow()
      .then(blobURL => {
         const videoStream = document.createElement("video");
         videoStream.autoplay = true;
         videoStream.src = blobURL;
      });
    }
  </script>
</body>
</html>
